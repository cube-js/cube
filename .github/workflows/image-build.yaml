name: image build

env:
  TAG: v0.35.80-gorgias

on:
  push:

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v8.1.5
          cache-image: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - uses: actions/checkout@v4

      - name: Login to GAR us-east1-docker.pkg.dev
        uses: docker/login-action@v3
        with:
          registry: us-east1-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCLOUD_SERVICE_KEY_FILE }}

      - name: Login to GAR us-central1-docker.pkg.dev
        uses: docker/login-action@v3
        with:
          registry: us-central1-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCLOUD_SERVICE_KEY_FILE }}

      - name: Build and push
        uses: docker/build-push-action@v6
        env:
          DOCKER_BUILD_CHECKS_ANNOTATIONS: false
          DOCKER_BUILD_RECORD_UPLOAD: false
          DOCKER_BUILD_SUMMARY: true
        with:
          push: true #Â ${{ github.ref == 'refs/heads/gorgias' }}
          context: rust/cubestore
          file: rust/cubestore/gorgias.Dockerfile
          tags: |
            us-east1-docker.pkg.dev/gorgias-helpdesk-staging/container-images/cubestore:${{ github.sha }}
            us-central1-docker.pkg.dev/gorgias-revenue-staging/container-images/cubestore:${{ github.sha }}
            us-east1-docker.pkg.dev/gorgias-helpdesk-production/container-images/cubestore:${{ github.sha }}
            us-central1-docker.pkg.dev/gorgias-revenue-production/container-images/cubestore:${{ github.sha }}
            us-east1-docker.pkg.dev/gorgias-helpdesk-staging/container-images/cubestore:${{ env.TAG }}
            us-central1-docker.pkg.dev/gorgias-revenue-staging/container-images/cubestore:${{ env.TAG }}
            us-east1-docker.pkg.dev/gorgias-helpdesk-production/container-images/cubestore:${{ env.TAG }}
            us-central1-docker.pkg.dev/gorgias-revenue-production/container-images/cubestore:${{ env.TAG }}
          cache-from: type=inline,image-manifest=true
          cache-to: type=inline,image-manifest=true
