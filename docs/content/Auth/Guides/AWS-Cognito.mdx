---
title: AWS Cognito Guide
permalink: /security/jwt/aws-cognito
category: Authentication & Authorization
subCategory: Guides
menuOrder: 4
---

## Introduction

In this guide, you'll learn how to integrate AWS Cognito authentication with a
Cube deployment. If you already have a pre-existing Cognito User Pool in AWS
that you'd like to re-use, please skip ahead to
[Configure Cube](#configure-cube-js).

## Create and configure a User Pool

If you haven't already created a User Pool, please follow [the instructions in
the AWS Cognito documentation][link-aws-cognito-hosted-ui] to create one, along
with enabling the Hosted UI.

### <--{"id" : "Create and configure a User Pool"}--> Custom claims

To add custom claims to the JWT, you will need to associate [a Lambda
function][link-aws-lambda] to the [Pre Token Generation event
trigger][link-aws-cognito-pre-token] available on your User Pool.

First, go to the AWS Lambda Console and create new a Lambda function:

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/9a878a2b-8a3c-4f3c-b8b8-107184f036a5/"
    style="border: none"
    width="80%"
  />
</div>

Add the following code to the Lambda function:

```javascript
exports.handler = (event, context, callback) => {
  event.response = {
    claimsOverrideDetails: {
      claimsToAddOrOverride: {
        'http://localhost:4000/': JSON.stringify({
          company_id: 'company1',
          user_id: event.request.userAttributes.sub,
          roles: ['user'],
        }),
      },
    },
  };
  callback(null, event);
};
```

Then navigate to the Amazon Cognito User Pools Console, select Triggers from the
left sidebar and associate the Lambda function you created previously:

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/88e8fe5b-96f5-48c8-a023-09fd3e56b70f/"
    style="border: none"
    width="80%"
  />
</div>

You can find more examples of [modifying claims in JWTs
here][link-aws-cognito-pretoken-example].

## Configure Cube

Now we're ready to configure Cube to use AWS Cognito. Go to your Cube
project and open the `.env` file and add the following, replacing the values
wrapped in `<>`.

```bash
CUBEJS_JWK_URL=https://cognito-idp.<AWS_REGION>.amazonaws.com/<USER_POOL_ID>/.well-known/jwks.json
CUBEJS_JWT_AUDIENCE=<APPLICATION_URL>
CUBEJS_JWT_ISSUER=https://cognito-idp.<AWS_REGION>.amazonaws.com/<USER_POOL_ID>
CUBEJS_JWT_ALGS=RS256
CUBEJS_JWT_CLAIMS_NAMESPACE=<CLAIMS_NAMESPACE>
```

## Testing with the Developer Playground

### <--{"id" : "Testing with the Developer Playground"}--> Retrieving a JWT

Go to the [OpenID Playground from Auth0][link-openid-playground] to and click
Configuration.

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/1f6423f3-b6c2-47e4-a915-eaae99c80fe3/"
    style="border: none"
    width="80%"
  />
</div>

Change the Server Template to Custom, and enter the following values:

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/111214a5-1a1e-43d1-b8f1-b895d5e2e83d/"
    style="border: none"
    width="80%"
  />
</div>

- **Discovery Document URL**:
  `https://cognito-idp.<AWS_REGION>.amazonaws.com/<USER_POOL_ID>/.well-known/openid-configuration`
- **OIDC Client ID**: Retrieve from App Client settings page in AWS Cognito User
  Pool Console
- **OIDC Client Secret**: Retrieve from App Client settings page in AWS Cognito
  User Pool Console

Click 'Use Discovery Document' to auto-fill the remaining values, then click
Save.

<WarningBox>

If you haven't already, go back to the AWS Cognito App Client's settings and add
`https://openidconnect.net/callback` to the list of allowed callback URLs.

</WarningBox>

Now click Start; and in a separate tab, go to the App Client's settings page and
click the Launch Hosted UI button.

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/c0436863-5aa2-4738-8b18-0f5f08fbbb1b/"
    style="border: none"
    width="80%"
  />
</div>

If the login is successful, you should be redirected to the OpenID Connect
Playground. Click on the Exchange button to exchange the code for your tokens:

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/2f8a5d22-3d99-4e3f-ad58-d805d999a1e7/"
    style="border: none"
    width="80%"
  />
</div>

Click Next, and continue on to the next section and click the Verify button to
verify the JWT signature as well as decode the identity token:

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/64d69aeb-b54b-42f4-b72b-a0c9f05f5ee2/"
    style="border: none"
    width="80%"
  />
</div>

### <--{"id" : "Testing with the Developer Playground"}--> Set JWT in Developer Playground

Now open the Developer Playground (at `http://localhost:4000`) and on the Build
page, click Add Security Context.

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/f301fb92-b8a8-41f4-a1ea-78b302dc2822/"
    style="border: none"
    width="80%"
  />
</div>

Click the Token tab, paste the `id_token` from OpenID Playground and click the
Save button.

<div style="text-align: center">
  <img
    src="https://ucarecdn.com/c4897c12-07d7-40c0-8198-bd132fd7bacd/"
    style="border: none"
    width="80%"
  />
</div>

Close the popup and use the Developer Playground to make a request. Any schemas
using the [Security Context][ref-sec-ctx] should now work as expected.

[link-aws-cognito-hosted-ui]:
  https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-app-integration.html#cognito-user-pools-create-an-app-integration
[link-aws-cognito-pre-token]:
  https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-pre-token-generation.html
[link-aws-cognito-pretoken-example]:
  https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-pre-token-generation.html#aws-lambda-triggers-pre-token-generation-example-1
[link-aws-lambda]: https://docs.aws.amazon.com/lambda/latest/dg/welcome.html
[link-openid-playground]: https://openidconnect.net/
[ref-sec-ctx]: /security/context
